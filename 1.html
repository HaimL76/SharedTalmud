<html>

<head>
    <link rel="stylesheet" href="1.css">
    <script src="jquery-3.6.0.js"></script>
    <!--<script type='text/javascript' src='utils.js'></script>-->
    <script type='text/javascript' src='hitTest.js'></script>
    <script type='text/javascript' src='sortedList.js'></script>
    <script type='text/javascript' src='timedFunctions.js'></script>
    <script>
        $(document).ready(function() {
            const loremIpsum = "Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.";

            const loremIpsumLength = loremIpsum.length;

            const randomString = (size) => {
                from = loremIpsumLength * Math.random();

                size %= (loremIpsumLength - from);

                return loremIpsum.substr(from, size);
            }

            //var int0 = setInterval(() => {
            $.ajax({
                type: "GET",
                url: `http://localhost:3000/comments/`,
                success: function(data) {
                    const width = window.screen.width * window.devicePixelRatio;
                    const height = window.screen.height * window.devicePixelRatio;

                    $('#resolution').val(`${height}, ${width}`);

                    console.log(data.toString);

                    mapRows = new sortedList(data.length);

                    mapCols = new sortedList(data.length);

                    comments = new Map();

                    data.forEach(c => comments.set(c[0], {
                        Id: c[0],
                        ResId: c[1],
                        Row: c[2],
                        Col: c[3],
                        First: c[4],
                        Last: c[5]
                    }));

                    comments.forEach(obj => mapRows.add(new listItem(obj.Row, {
                        Row: obj.Row,
                        Col: obj.Col,
                        Id: obj.Id
                    })));

                    comments.forEach(obj => mapCols.add(new listItem(obj.Col, {
                        Row: obj.Row,
                        Col: obj.Col,
                        Id: obj.Id
                    })));

                    countdown = topOpacity;
                    timestamp = Date.now();

                    //alert(JSON.stringify(data));
                    window.requestAnimationFrame(drawCircles);
                }
            });
            //},
            //1800);

            let comments;

            let mapRows, mapCols;

            const pageImage = new Image;
            pageImage.src = 'featured-image-backyard-landscaping.jpeg';
            const topOpacity = 0; // 28;
            const interval = 75; //ms

            let countdown;

            let timestamp;

            let centerX, centerY, radius = 5;

            //var design = $(this).attr('data-design');
            //var id = $(this).attr('id');
            var canvas = $("#page-image")[0];

            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            var ctx = canvas.getContext("2d");
            var img = new Image;
            img.onload = function() {
                ctx.drawImage(this, 0, 0);
            };
            img.src = 'featured-image-backyard-landscaping.jpeg';

            $('#page-image').mousemove(function(e) {
                var tipCanvas = $("#tip")[0];

                let hitComment = false;

                const left = $("#page-image").position().left;
                const top = $("#page-image").position().top;

                row = e.pageY - top;
                col = e.pageX - left;

                $('#dynamic-status').val(col + ', ' + row);

                if (mapRows && mapCols) {
                    const hit = hitTest(comments, row, col, [mapRows, mapCols]);

                    if (hit && hit.dist < hitTestDistSquare) {
                        hitComment = true;

                        const Id = hit.obj.val.Id;

                        if (comments.has(Id)) {

                            const c = comments.get(Id);

                            text = `${c.First} ${c.Last}`;

                            var tipCtx = tipCanvas.getContext("2d");

                            tipCtx.clearRect(0, 0, tipCanvas.width, tipCanvas.height);

                            dispRow = hit.obj.val.Row + top - 35;
                            dispCol = hit.obj.val.Col + left;

                            tipCanvas.style.left = dispCol + "px";
                            tipCanvas.style.top = dispRow + "px";

                            tipCtx.clearRect(0, 0, tipCanvas.width, tipCanvas.height);

                            //tipCtx.fillText('Hello World', 10, 100, tipCanvas.width);
                            textWidth = tipCtx.measureText(text).width;

                            //tipCanvas.style.width = textWidth + 10;

                            tipCtx.fillText(text, 5, 15);
                            //}, 250);
                        }
                    }
                }

                if (mapRows) {
                    //const keysRows = mapRows.keys();
                    mapRows.printConsole();
                }

                if (mapCols) {
                    //const keysCols = mapCols.keys();
                }

                if (!hitComment && tipCanvas && "style" in tipCanvas)
                    tipCanvas.style.top = tipCanvas.style.left = -1000;
            });

            $('#page-image').click(function(e) {
                var tipCanvas = $("#tip")[0];

                let hitComment = false;

                const left = $("#page-image").position().left;
                const top = $("#page-image").position().top;

                row = e.pageY - top;
                col = e.pageX - left;

                $('#dynamic-status').val(col + ', ' + row);

                if (mapRows && mapCols) {
                    const hit = hitTest(comments, row, col, [mapRows, mapCols]);

                    if (hit && hit.dist < hitTestDistSquare) {
                        hitComment = true;

                        const Id = hit.obj.val.Id;

                        if (comments.has(Id)) {

                            const c = comments.get(Id);

                            text = `${c.First} ${c.Last}`;

                            const div0 = $(".comment-text")[0];

                            div0.innerHTML = text;

                            let a = 0;

                            //.innerHTML(text);
                            //}, 250);
                        }
                    }
                }

                if (mapRows) {
                    //const keysRows = mapRows.keys();
                    mapRows.printConsole();
                }

                if (mapCols) {
                    //const keysCols = mapCols.keys();
                }

                if (!hitComment && tipCanvas && "style" in tipCanvas)
                    tipCanvas.style.top = tipCanvas.style.left = -1000;
            });

            $("#page-image").dblclick(function(e) {
                const left = $("#page-image").position().left;
                const top = $("#page-image").position().top;

                row = e.pageY - top;
                col = e.pageX - left;

                $('#static-status').val(col + ', ' + row);

                insert(1, 1, row, col);

                centerX = col;
                centerY = row;

                countdown = topOpacity;
                timestamp = Date.now();

                window.requestAnimationFrame(drawCircles);
            });

            const drawCircles = function() {
                const [ts, cd] = intervalFunction(interval, timestamp, countdown, (counter) => {
                    const canvas = $("#page-image")[0];
                    const ctx = canvas.getContext('2d');

                    //ctx.globalCompositeOperation = 'destination-over';
                    ctx.clearRect(0, 0, canvas.width, canvas.height); // clear canvas

                    ctx.drawImage(pageImage, 0, 0); //-12 * countDown, -12);

                    const alpha = topOpacity < 1 ?
                        1 :
                        counter / topOpacity;

                    const str_rgba = `rgba(0, 255, 255, ${alpha})`;

                    comments.forEach(element => {
                        ctx.beginPath();

                        ctx.arc(element.Col, element.Row, radius, 0, 2 * Math.PI, false);

                        ctx.fillStyle = str_rgba;
                        ctx.fill();
                        ctx.lineWidth = 1;
                        ctx.strokeStyle = 'black';
                        ctx.stroke();
                    });

                    //ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI, false);
                    //ctx.lineWidth = 5;
                    //ctx.strokeStyle = '#003300';
                    //ctx.stroke();

                    /*
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.4)';
                    ctx.strokeStyle = 'rgba(0, 153, 255, 0.4)';
                    ctx.save();
                    ctx.translate(150, 150);

                    // Earth
                    var time = new Date();
                    ctx.rotate(((2 * Math.PI) / 60) * time.getSeconds() + ((2 * Math.PI) / 60000) * time.getMilliseconds());
                    ctx.translate(105, 0);
                    ctx.fillRect(0, -12, 40, 24); // Shadow
                    ctx.drawImage(pageImage, -12, -12);

                    // Moon
                    ctx.save();
                    ctx.rotate(((2 * Math.PI) / 6) * time.getSeconds() + ((2 * Math.PI) / 6000) * time.getMilliseconds());
                    ctx.translate(0, 28.5);
                    ctx.drawImage(moon, -3.5, -3.5);
                    ctx.restore();

                    ctx.restore();

                    ctx.beginPath();
                    ctx.arc(150, 150, 105, 0, Math.PI * 2, false); // Earth orbit
                    ctx.stroke();

                    ctx.drawImage(sun, 0, 0, 300, 300);
                    */
                });

                countdown = cd;
                timestamp = ts;

                if (countdown >= 0)
                    window.requestAnimationFrame(drawCircles);
            }

            const insert = function(authorId, resId, row, col) {
                //var text = prompt("כתוב את חידושך", "");
                const text = randomString(10);

                const data = {
                    resId: resId,
                    row: row,
                    col: col,
                    text: text,
                    authorId: authorId
                };

                const strData = JSON.stringify(data);

                $.ajax({
                    type: "POST",
                    data: strData,
                    url: `http://localhost:3000/comments/`,
                    success: function(data) {
                        console.log(data.toString);

                        //alert(JSON.stringify(data));
                    }
                });
            };
            /*
                        const canvas = $('#canvi')[0]; // 

                        //canvas.width = 800;
                        //canvas.height = 600;

                        //const canvas = document.getElementById("canvi");

                        const context = canvas.getContext('2d');

                        const image = new Image();

                        image.src = "featured-image-backyard-landscaping.jpeg"; // can also be a remote URL e.g. http://

                        image.onload = function() {
                            canvas.height = image.height;
                            canvas.width = image.width;

                            context.drawImage(image, 0, 0);
                        };
                        */
        })
    </script>
</head>
<style>
    /*
    #page-image {
        position: absolute;
        top: 0px;
        left: 0px;
    }
    
    input[type=text] {
        position: absolute;
        top: 500px;
    }
    */
</style>

<body>
    <style>

    </style>
    <div class="super-container">
        <input type="text" id="dynamic-status" />
        <input type="text" id="static-status" />
        <div class="comment-text">
        </div>
        <!--<div class="inner-container">-->
        <div class="container">
            <!--<img id="page-image" src="featured-image-backyard-landscaping.jpeg" alt="featured-image-backyard-landscaping.jpeg">-->
            <canvas id="page-image"><!--</canvas> width="200" height="100" style="border:1px solid #000000;">-->
            </canvas>
            <canvas id="tip" width=100 height=25></canvas>
            </canvas>
        </div>
        <!--<input type="text" id="resolution" />-->
    </div>
    <!--</div>-->
    <!--<canvas id="canvi" />-->
</body>

</html>