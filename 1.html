<html>

<head>
    <link rel="stylesheet" href="1.css">
    <link rel="stylesheet" href="list.css">
    <script src="jquery-3.6.0.js"></script>
    <!--<script type='text/javascript' src='utils.js'></script>-->
    <script type='text/javascript' src='hitTest.js'></script>
    <script type='text/javascript' src='sortedList.js'></script>
    <script type='text/javascript' src='menuBuilder.js'></script>
    <script type='text/javascript' src='timedFunctions.js'></script>
    <script>
        $(document).ready(async function() {
            let comments;

            let mapRows, mapCols;

            const pageImage = new Image;
            pageImage.src = 'featured-image-backyard-landscaping.jpeg';
            const topOpacity = 0; // 28;
            const interval = 75; //ms

            let countdown;

            let timestamp;

            let centerX, centerY, radius = 5;

            const loremIpsum = "Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.";

            const loremIpsumLength = loremIpsum.length;

            const randomString = (size) => {
                from = loremIpsumLength * Math.random();

                size %= (loremIpsumLength - from);

                return loremIpsum.substr(from, size);
            }

            const drawCircles = function() {
                const [ts, cd] = intervalFunction(interval, timestamp, countdown, (counter) => {
                    const canvas = $("#page-image")[0];
                    const ctx = canvas.getContext('2d');

                    //ctx.globalCompositeOperation = 'destination-over';
                    ctx.clearRect(0, 0, canvas.width, canvas.height); // clear canvas

                    ctx.drawImage(pageImage, 0, 0); //-12 * countDown, -12);

                    const alpha = topOpacity < 1 ?
                        1 :
                        counter / topOpacity;

                    const str_rgba = `rgba(0, 255, 255, ${alpha})`;

                    mapRows.arr.forEach(element => {
                        ctx.beginPath();

                        ctx.arc(element.getVal(Col), element.getVal(Row), radius, 0, 2 * Math.PI, false);

                        ctx.fillStyle = str_rgba;
                        ctx.fill();
                        ctx.lineWidth = 1;
                        ctx.strokeStyle = 'black';
                        ctx.stroke();
                    });
                });

                countdown = cd;
                timestamp = ts;

                if (countdown >= 0)
                    window.requestAnimationFrame(drawCircles);
            }

            const Row = "Row";
            const Col = "Col";
            const val = "val";

            const menu = new menuBuilder([{
                api: 'http://localhost:3000/categories/',
                name: "cat"
            }]);

            menu.buildMenuItem(null);

            menu.addToExternal("sideMenu");

            const pref_cat = "cat_";
            const pref_cat_len = pref_cat.length;

            const pref_book = "book_";
            const pref_book_len = pref_book.length;

            const Plus = "&#43;"
            const Minus = "&#8722;"

            const getSign = (plus) =>
                plus ? Plus : Minus;

            await $.ajax({
                type: "GET",
                url: `http://localhost:3000/categories/`,
                success: function(data) {
                    if (Array.isArray(data) && data.length > 0) {
                        data.forEach(arr => $("#ulCategories").append(`<li id="cat_${arr[0]} class="close"><span class="beforeCaret">${Plus}</span><span class="caret">${arr[1]}</span></li>`));

                        $('ul.cats > li').each(function() {
                            console.log($(this).attr('id'));
                        });

                        $('ul.cats > li').click(async function() {
                            const $liCat = $(this);

                            let idCat = $(this).attr('id');

                            idCat = idCat.substring(pref_cat_len);

                            idCat = parseInt(idCat);

                            const len = $liCat.children("ul").length;

                            if (len > 0) {
                                $(`#${pref_cat}${idCat} > ul`).remove();

                                $(`#${pref_cat}${idCat}`).removeClass("Open");
                                $(`#${pref_cat}${idCat}`).addClass("Close");
                            } else {
                                await $.ajax({
                                    type: "GET",
                                    url: `http://localhost:3000/books/${idCat}`,
                                    success: function(data) {
                                        if (Array.isArray(data) && data.length > 0) {
                                            data.forEach(arr0 => console.log(arr0));

                                            idCat = `catbooks_${idCat}`

                                            $liCat.append(`<ul class="books" id="${idCat}">`);

                                            data.forEach(arr => $(`#${idCat}`).append(`<li id="book_${arr[0]}"><span class="caret">${arr[1]}</span></li>`));

                                            $liCat.append(`</ul>`);

                                            $('ul.books > li').click(async function() {
                                                const $liBook = $(this);

                                                let idBook = $(this).attr('id');

                                                idBook = idBook.substring(pref_book_len);

                                                idBook = parseInt(idBook);

                                                const len = $liBook.children("ul").length;

                                                if (len > 0)
                                                    $(`#${pref_book}${idBook} > ul`).remove();
                                                else
                                                    await $.ajax({
                                                        type: "GET",
                                                        url: `http://localhost:3000/resources/${idBook}`,
                                                        success: function(data) {
                                                            if (Array.isArray(data) && data.length > 0) {
                                                                data.forEach(arr0 => console.log(arr0));

                                                                idBook = `bookres_${idBook}`

                                                                $liBook.append(`<ul class="res" id="${idBook}">`);

                                                                data.forEach(arr => $(`#${idBook}`).append(`<li id="res_${arr[0]}"><span class="caret">${arr[1]}</span></li>`));

                                                                $liBook.append(`</ul>`);
                                                            }
                                                        }
                                                    });
                                            });
                                        }
                                    }
                                });
                            }
                        });
                    }
                }
            });

            //var int0 = setInterval(() => {
            await $.ajax({
                type: "GET",
                url: `http://localhost:3000/comments/`,
                success: function(data) {
                    const width = window.screen.width * window.devicePixelRatio;
                    const height = window.screen.height * window.devicePixelRatio;

                    $('#resolution').val(`${height}, ${width}`);

                    console.log(data.toString);

                    mapRows = new sortedList(data.length);

                    //comments = new Map();

                    //data.forEach(c => comments.set(c[0], {
                    //  Id: c[0],
                    //                        ResId: c[1],
                    //Row: c[2],
                    //Col: c[3],
                    //First: c[4],
                    //Last: c[5]
                    //}));

                    data.forEach(c => mapRows.add(new listItem({
                        Id: c[0],
                        ResId: c[1],
                        Row: c[2],
                        Col: c[3],
                        First: c[4],
                        Last: c[5]
                    }), Row));

                    //comments.forEach(obj => mapCols.add(new listItem(obj.Col, {
                    //  Row: obj.Row,
                    //Col: obj.Col,
                    //Id: obj.Id
                    //})));

                    countdown = topOpacity;
                    timestamp = Date.now();

                    //alert(JSON.stringify(data));
                    window.requestAnimationFrame(drawCircles);
                }
            });
            //},
            //1800);

            //var design = $(this).attr('data-design');
            //var id = $(this).attr('id');
            var canvas = $("#page-image")[0];

            canvas.width = 1000; // window.innerWidth;
            canvas.height = 500; //window.innerHeight;

            var ctx = canvas.getContext("2d");
            var img = new Image;
            img.onload = function() {
                ctx.drawImage(this, 0, 0, canvas.width, canvas.height);
            };
            img.src = 'featured-image-backyard-landscaping.jpeg';

            $('#page-image').mousemove(function(e) {
                var tipCanvas = $("#tip")[0];

                let hitComment = false;

                const left = $("#page-image").position().left;
                const top = $("#page-image").position().top;

                row = e.pageY - top;
                col = e.pageX - left;

                //$('#dynamic-status').val(col + ', ' + row);

                mapCols = new sortedList();

                if (mapRows && mapCols) {
                    const hit = hitTest(row, col, [mapRows, mapCols]);

                    if (hit && val in hit) { //} && hit.dist < hitTestDistSquare) {
                        hitComment = true;

                        const c = hit.val;

                        text = `${c.First} ${c.Last}`;

                        var tipCtx = tipCanvas.getContext("2d");

                        tipCtx.clearRect(0, 0, tipCanvas.width, tipCanvas.height);

                        dispRow = c.Row + top - 35;
                        dispCol = c.Col + left;

                        tipCanvas.style.left = dispCol + "px";
                        tipCanvas.style.top = dispRow + "px";

                        tipCtx.clearRect(0, 0, tipCanvas.width, tipCanvas.height);

                        //tipCtx.fillText('Hello World', 10, 100, tipCanvas.width);
                        textWidth = tipCtx.measureText(text).width;

                        //tipCanvas.style.width = textWidth + 10;

                        tipCtx.fillText(text, 5, 15);
                        //}, 250);
                    }
                }

                if (mapRows) {
                    //const keysRows = mapRows.keys();
                    mapRows.printConsole();
                }

                if (mapCols) {
                    //const keysCols = mapCols.keys();
                }

                if (!hitComment && tipCanvas && "style" in tipCanvas)
                    tipCanvas.style.top = tipCanvas.style.left = -1000;
            });

            $('#page-image').click(function(e) {
                var tipCanvas = $("#tip")[0];

                let hitComment = false;

                const left = $("#page-image").position().left;
                const top = $("#page-image").position().top;

                row = e.pageY - top;
                col = e.pageX - left;

                $('#dynamic-status').val(col + ', ' + row);

                mapCols = new sortedList();

                if (mapRows && mapCols) {
                    const hit = hitTest(row, col, [mapRows, mapCols]);

                    if (hit && val in hit) { //}.dist < hitTestDistSquare) {
                        hitComment = true;

                        const c = hit.val;

                        text = `${c.First} ${c.Last}`;

                        const div0 = $(".comment-text")[0];

                        div0.innerHTML = text;

                        let a = 0;

                        //.innerHTML(text);
                        //}, 250);
                    }
                }

                if (mapRows) {
                    //const keysRows = mapRows.keys();
                    mapRows.printConsole();
                }

                if (mapCols) {
                    //const keysCols = mapCols.keys();
                }

                if (!hitComment && tipCanvas && "style" in tipCanvas)
                    tipCanvas.style.top = tipCanvas.style.left = -1000;
            });

            $("#page-image").dblclick(function(e) {
                const left = $("#page-image").position().left;
                const top = $("#page-image").position().top;

                row = e.pageY - top;
                col = e.pageX - left;

                //$('#static-status').val(col + ', ' + row);

                insert(1, 1, row, col);

                centerX = col;
                centerY = row;

                countdown = topOpacity;
                timestamp = Date.now();

                window.requestAnimationFrame(drawCircles);
            });

            const insert = function(authorId, resId, row, col) {
                //var text = prompt("כתוב את חידושך", "");
                const text = randomString(10);

                const data = {
                    resId: resId,
                    row: row,
                    col: col,
                    text: text,
                    authorId: authorId
                };

                const strData = JSON.stringify(data);

                $.ajax({
                    type: "POST",
                    data: strData,
                    url: `http://localhost:3000/comments/`,
                    success: function(data) {
                        console.log(data.toString);

                        //alert(JSON.stringify(data));
                    }
                });
            };
            /*
                        const canvas = $('#canvi')[0]; // 

                        //canvas.width = 800;
                        //canvas.height = 600;

                        //const canvas = document.getElementById("canvi");

                        const context = canvas.getContext('2d');

                        const image = new Image();

                        image.src = "featured-image-backyard-landscaping.jpeg"; // can also be a remote URL e.g. http://

                        image.onload = function() {
                            canvas.height = image.height;
                            canvas.width = image.width;

                            context.drawImage(image, 0, 0);
                        };
                        */
        })
    </script>
</head>
<style>
    /*
    #page-image {
        position: absolute;
        top: 0px;
        left: 0px;
    }
    
    input[type=text] {
        position: absolute;
        top: 500px;
    }
    */
</style>

<body>
    <style>

    </style>
    <div class="super-container">
        <div id="sideMenu" class="list-container">
            <ul class="cats" id="ulCategories">

            </ul>
        </div>

        <!--<div class="inner-container">-->
        <div class="container">
            <!--<img id="page-image" src="featured-image-backyard-landscaping.jpeg" alt="featured-image-backyard-landscaping.jpeg">-->
            <canvas id="page-image"><!--</canvas> width="200" height="100" style="border:1px solid #000000;">-->
            </canvas>
            <canvas id="tip" width=100 height=25></canvas>
            </canvas>
            <div class="comment-text">
            </div>
        </div>
        <!--<input type="text" id="resolution" />-->
    </div>
    <!--</div>-->
    <!--<canvas id="canvi" />-->
</body>

</html>