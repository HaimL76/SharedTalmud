<html>

<head>
    <script src="jquery-3.6.0.js"></script>
    <script type='text/javascript' src='hitTest.js'></script>
    <script type='text/javascript' src='timedFunctions.js'></script>
    <script>
        $(document).ready(function() {
            var int0 = setInterval(() => {
                $.ajax({
                    type: "GET",
                    url: `http://localhost:3000/comments/`,
                    success: function(data) {
                        const width = window.screen.width * window.devicePixelRatio;
                        const height = window.screen.height * window.devicePixelRatio;

                        $('#resolution').val(`${height}, ${width}`);

                        console.log(data.toString);

                        comments = new Map();
                        //mapRows = new Map();
                        //mapCols = new Map();

                        data.forEach(c => comments.set(c[0], c));
                        //data.forEach(c => mapRows.set(c[2], c[0]));
                        //data.forEach(c => mapCols.set(c[3], c[0]));

                        countdown = topOpacity;
                        timestamp = Date.now();

                        //alert(JSON.stringify(data));
                        window.requestAnimationFrame(drawCircles);
                    }
                });
            }, 1800);

            let comments;

            let mapRows, mapCols;

            const pageImage = new Image;
            pageImage.src = 'featured-image-backyard-landscaping.jpeg';
            const topOpacity = 28;
            const interval = 75; //ms

            let countdown;

            let timestamp;

            let centerX, centerY, radius = 5;

            //var design = $(this).attr('data-design');
            //var id = $(this).attr('id');
            var canvas = $("#page-image")[0];

            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            var ctx = canvas.getContext("2d");
            var img = new Image;
            img.onload = function() {
                ctx.drawImage(this, 0, 0);
            };
            img.src = 'featured-image-backyard-landscaping.jpeg';

            $('#page-image').mousemove(function(e) {
                const left = $("#page-image").position().left;
                const top = $("#page-image").position().top;

                row = e.pageY - top;
                col = e.pageX - left;

                $('#dynamic-status').val(col + ', ' + row);

                const c = hitTest(row, col, comments);

                if (mapRows) {
                    const keysRows = mapRows.keys();
                }

                if (mapCols) {
                    const keysCols = mapCols.keys();
                }
            });

            $("#page-image").dblclick(function(e) {
                const left = $("#page-image").position().left;
                const top = $("#page-image").position().top;

                row = e.pageY - top;
                col = e.pageX - left;

                $('#static-status').val(col + ', ' + row);

                insert(1, row, col);

                centerX = col;
                centerY = row;

                countdown = topOpacity;
                timestamp = Date.now();

                window.requestAnimationFrame(drawCircles);
            });

            const drawCircles = function() {
                const [ts, cd] = intervalFunction(interval, timestamp, countdown, (counter) => {
                    const canvas = $("#page-image")[0];
                    const ctx = canvas.getContext('2d');

                    //ctx.globalCompositeOperation = 'destination-over';
                    ctx.clearRect(0, 0, canvas.width, canvas.height); // clear canvas

                    ctx.drawImage(pageImage, 0, 0); //-12 * countDown, -12);

                    const alpha = counter / topOpacity;

                    const str_rgba = `rgba(0, 255, 255, ${alpha})`;

                    comments.forEach(element => {
                        ctx.beginPath();

                        ctx.arc(element[3], element[2], radius, 0, 2 * Math.PI, false);

                        ctx.fillStyle = str_rgba;
                        ctx.fill();
                        ctx.lineWidth = 1;
                        ctx.strokeStyle = 'black';
                        ctx.stroke();
                    });

                    //ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI, false);
                    //ctx.lineWidth = 5;
                    //ctx.strokeStyle = '#003300';
                    //ctx.stroke();

                    /*
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.4)';
                    ctx.strokeStyle = 'rgba(0, 153, 255, 0.4)';
                    ctx.save();
                    ctx.translate(150, 150);

                    // Earth
                    var time = new Date();
                    ctx.rotate(((2 * Math.PI) / 60) * time.getSeconds() + ((2 * Math.PI) / 60000) * time.getMilliseconds());
                    ctx.translate(105, 0);
                    ctx.fillRect(0, -12, 40, 24); // Shadow
                    ctx.drawImage(pageImage, -12, -12);

                    // Moon
                    ctx.save();
                    ctx.rotate(((2 * Math.PI) / 6) * time.getSeconds() + ((2 * Math.PI) / 6000) * time.getMilliseconds());
                    ctx.translate(0, 28.5);
                    ctx.drawImage(moon, -3.5, -3.5);
                    ctx.restore();

                    ctx.restore();

                    ctx.beginPath();
                    ctx.arc(150, 150, 105, 0, Math.PI * 2, false); // Earth orbit
                    ctx.stroke();

                    ctx.drawImage(sun, 0, 0, 300, 300);
                    */
                });

                countdown = cd;
                timestamp = ts;

                if (countdown >= 0)
                    window.requestAnimationFrame(drawCircles);
            }

            const insert = function(resId, row, col) {
                var text = prompt("כתוב את חידושך", "");

                const data = {
                    resId: resId,
                    row: row,
                    col: col,
                    text: text
                };

                const strData = JSON.stringify(data);

                $.ajax({
                    type: "POST",
                    data: strData,
                    url: `http://localhost:3000/comments/`,
                    success: function(data) {
                        console.log(data.toString);

                        //alert(JSON.stringify(data));
                    }
                });
            };
            /*
                        const canvas = $('#canvi')[0]; // 

                        //canvas.width = 800;
                        //canvas.height = 600;

                        //const canvas = document.getElementById("canvi");

                        const context = canvas.getContext('2d');

                        const image = new Image();

                        image.src = "featured-image-backyard-landscaping.jpeg"; // can also be a remote URL e.g. http://

                        image.onload = function() {
                            canvas.height = image.height;
                            canvas.width = image.width;

                            context.drawImage(image, 0, 0);
                        };
                        */
        })
    </script>
</head>
<style>
    /*
    #page-image {
        position: absolute;
        top: 0px;
        left: 0px;
    }
    
    input[type=text] {
        position: absolute;
        top: 500px;
    }
    */
    
    .super-container {
        display: flex;
        flex-direction: row;
        position: absolute;
        top: 0px;
        left: 0px;
    }
    
    .inner-container {
        display: flex;
        flex-direction: column;
        position: relative;
        top: 0px;
        left: 0px;
    }
    
    .container {
        display: flex;
        flex-direction: column;
    }
</style>

<body>
    <div class="super-container">
        <input type="text" id="dynamic-status" />
        <input type="text" id="static-status" />

        <!--<div class="inner-container">-->
        <div class="container">
            <!--<img id="page-image" src="featured-image-backyard-landscaping.jpeg" alt="featured-image-backyard-landscaping.jpeg">-->
            <canvas id="page-image"><!--</canvas> width="200" height="100" style="border:1px solid #000000;">-->
            </canvas>
        </div>
        <!--<input type="text" id="resolution" />-->
    </div>
    <!--</div>-->
    <!--<canvas id="canvi" />-->
</body>

</html>